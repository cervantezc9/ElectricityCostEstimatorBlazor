@page "/"

@using ElectricityCostEstimatorBlazor.Services
@using ElectricityCostEstimatorBlazor.ViewModels
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components.QuickGrid

@inject ElectricityEstimatorService estimatorService;

@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

<h1>Electricity Cost Estimator</h1>

@if (Estimates?.Count > 0)
{
    <div class="container border rounded p-3 pb-0 col-12" style="overflow:auto">
        <QuickGrid Class="table table-striped border rounded"
                Items="@Estimates.AsQueryable()"
                ItemKey="@(est => est.Id)">
            <PropertyColumn Title="Plan Name" Property="@(est => est.ElectricityPlan.Name)" Sortable="true"></PropertyColumn>
            <PropertyColumn Title="Base Charge" Property="@(est => est.ElectricityPlan.BaseCharge)" Sortable="true" Format="C2"></PropertyColumn>
            <PropertyColumn Title="Credit" Property="@(est => est.ElectricityPlan.Credit)" Sortable="true" Format="C2"></PropertyColumn>
            <PropertyColumn Title="Credit Min Usage" Property="@(est => est.ElectricityPlan.CreditMinimumUsage)" Sortable="true"></PropertyColumn>
            <PropertyColumn Title="Delivery Provider" Property="@(est => est.Delivery.ProviderName)" Sortable="true"></PropertyColumn>
            <PropertyColumn Title="Annual Cost" Property="@(est => est.GetAnnualTotal())" Sortable="true" Format="C2"></PropertyColumn>
        </QuickGrid>
    </div>
}
else
{
    <p>Add a new electricity plan to start.</p>
}

@code{
    [Parameter]
    public int EstimateId { get; set; }

    private int _estimateId { get; set; } = 0;
    private EstimateViewModel Estimate { get; set; } = new();
    private List<EstimateViewModel> Estimates { get; set; } = [];

    protected override async Task OnInitializedAsync()
    {
        _estimateId = EstimateId;

        var dbEstimates = await estimatorService.GetAllEstimates();
        Estimates = dbEstimates?.Select(est => new EstimateViewModel()
        {
            Id = est.Id,
            ElectricityPlan = new()
            {
                Id = est.ElectricityPlan.Id,
                Name = est.ElectricityPlan.Name,
                BaseCharge = est.ElectricityPlan.BaseCharge,
                Credit = est.ElectricityPlan.Credit,
                CreditMinimumUsage = est.ElectricityPlan.CreditMinimumUsage,
                ElectricityPlanRates = est.ElectricityPlan.ElectricityPlanRates?.Select(rate => new ElectricityPlanRate()
                {
                    Id = rate.Id,
                    Rate = rate.Rate,
                    kWhMinimumUsage = rate.kWhMinimumUsage,
                    kWhMaximumUsage = rate.kWhMaximumUsage
                }).ToList() ?? []
            },
            Delivery = new()
            {
                Id = est.Delivery.Id,
                ProviderName = est.Delivery.ProviderName,
                MonthlyCharge = est.Delivery.MonthlyCharge,
                KWhCharge = est.Delivery.KWhCharge
            },
            MonthlyUsages = est.MonthlyUsages?.Select(usage => new ViewModels.MonthlyUsage()
            {
                Id = usage.Id,
                Month = (int)usage.Month,
                Usage = usage.Usage
            }).ToList() ?? []
        }).ToList() ?? [];
    }

    // public async Task OnEstimateChanged(int id)
    // {
    //     _estimateId = id;
    // }
}